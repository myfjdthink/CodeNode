<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>自动寻路贪吃蛇</title>
    <script type="text/javascript" src="AStar.js"></script>
</head>
<body>
<canvas id="myCanvas" width="480 " height="480" style="border:1px solid #d3d3d3;">
    Your browser does not support the HTML5 canvas tag.
</canvas>
<div>
    <button onclick="startComputerGame();">
        重开
    </button>
</div>
<div>
    <span>长度:</span>
    <span id="score">0</span>
</div>
<div>
    <span id="dead"></span>
</div>

<script>
    var ctx = document.getElementById("myCanvas").getContext("2d");
    var pointSize = 20;
    var length = 24
    //方向
    var up = 38, down = 40, left = 37, right = 39;
    //蛇
    var snake = [{
        x: 10,
        y: 9
    }, {
        x: 10,
        y: 8
    }];
    //co表示蛇前进的方向，默认向下
    var direct = down;
    //自动寻路
    var auto = true;
    //flood食物
    var flood = null;
    var score = document.getElementById("score");
    var dead = document.getElementById("dead");
    //给蛇加上阴影效果
    ctx.shadowBlur = 20, ctx.shadowColor = "blue";
    function init() {
        window.clearInterval(id)
        ctx.clearRect(0, 0, pointSize * length, pointSize * length);
        snake = [{
            x: 10,
            y: 9
        }, {
            x: 10,
            y: 8
        }];
        direct = down;
        flood = null;
        dead.innerHTML = '';
    }

    function startComputerGame() {
//        if (auto)
//            return;
        //循环，间隔为30毫秒
        init();
        auto = true;
        setInterval(moveSnake, 30);
    }

    /**
     * 判断游戏是否结束
     * @param head
     * @returns {boolean}
     */
    function isGameOver(head) {
        // 撞到身体
        if (hitFood(head, 0)) {
            return true;
        }
        // 撞到墙
        if (head.x < 0 || head.x >= length || head.y < 0 || head.y >= length) {
            return true;
        }
        return false
    }

    var id = setInterval(moveSnake, 1000);

    var drawSnake = function () {
        //清空屏幕
        ctx.clearRect(0, 0, pointSize * length, pointSize * length);
        //如果有食物，则绘制食物
        if (flood)
            ctx.fillRect(flood.x * pointSize, flood.y * pointSize, pointSize, pointSize);

        for (var i = 0; i < snake.length; i++)
            ctx.fillRect(snake[i].x * pointSize, snake[i].y * pointSize, pointSize, pointSize);
    };
    function nodeEqual(nodeA, nodeB) {
        return nodeA.x === nodeB.x && nodeA.y === nodeB.y
    }

    //如果没有食物，则在随机位置上加入一粒食物
    function genFood() {
        while (flood == null || hitFood(flood))
            flood = {
                y: (Math.random() * length >>> 0),
                x: (Math.random() * length >>> 0)
            };
    }
    function moveSnake() {
        //游戏是否已经结束
        if (isGameOver(snake[0])) {
            window.clearInterval(id);
            dead.innerHTML = '挂啦';
            return;
        }
        genFood()
        var next = getNext(direct)
        nodeEqual(next, flood || {})//吃了食物
                ? (snake.unshift(flood), flood = null)
                //只是移动
                : (snake.unshift(next) && snake.pop());

        //绘制蛇
        drawSnake();
        //分数
        score.innerHTML = snake.length;

        //判断游戏是否结束
        if (isGameOver(snake[0])) {
            window.clearInterval(id);
            dead.innerHTML = '挂B啦';
            return;
        }
        //alert("game over\nYou get [" + (snake.length - 2) + "]");
    }

    //加入键盘事件，用方向键来控制蛇前进的方向
    document.onkeyup = function (event) {
        direct = event.keyCode >= 37 && event.keyCode <= 40 && (Math.abs(event.keyCode - direct) != 2) ? event.keyCode : direct;
    }

    //判断指定位置是否与蛇重叠
    function hitFood(flood, j) {
        for (var i = 0; i < snake.length; i++)
            if (j != i && nodeEqual(snake[i], flood))
                return true;
        return false;
    }

    var paths = []
    //根据给定的方向取下一步的位置
    function getNext(d) {
        if (paths.length === 0) {
            paths = genPaths()
            drawPaths()
        }
        var next = paths.pop()
        return {x: next[0], y: next[1]};
    }

    function genPaths() {
        var find = AStar(initGrid(), [snake[0].x, snake[0].y], [flood.x, flood.y], "Manhattan")
        console.log('find', find);
        return find
    }

    function drawPaths() {
        console.log('drawPaths', paths.length);
        ctx.fillStyle="#0000ff";
        for (var i = 0; i < paths.length; i++)
            ctx.fillRect(paths[i].x * pointSize, paths[i].y * pointSize, pointSize, pointSize);
        ctx.fillStyle="black";
    }

    var grid = null
    function initGrid() {
        if (!grid) {
            var grid = []
            for (var i = 0; i < length; i++) {
                grid[i] = new Array(length);
                for (var j = 0; j < length; j++) {
                    grid[i][j] = 0
                }
            }
        }
        for (var i = 0; i < snake.length; i++) {
            grid[snake[i].x][snake[i].y] = 1
        }
        return grid
    }

    function isDeadEnd(next, d) {
        var i = getIndex(next);
        var node = snake[i - 1];
        if (d == up && node.y + 1 == next.y)
            return true;
        if (d == down && node.y - 1 == next.y)
            return true;
        if (d == left && node.x + 1 == next.x)
            return true;
        if (d == right && node.x - 1 == next.x)
            return true;
        return false;
    }

</script>
</body>
</html>
